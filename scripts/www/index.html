<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>PID 模拟器 - 刘飞制作</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body { background:#0b1219; color:#adbac7; font-family:sans-serif; height:100vh; display:flex; flex-direction:column; overflow:hidden; }
  .card { background:#1c2128; border:1px solid #30363d; border-radius:12px; padding:10px; position:relative; }
  .lcd { font-family: 'Courier New', monospace; font-weight: bold; }
  .tab-active { background: #1f6feb; color: white; border-color: #58a6ff; }
  input[type=range] { -webkit-appearance: none; width: 100%; height: 6px; background: #30363d; border-radius: 3px; outline: none; margin: 12px 0; }
  input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 18px; width: 18px; border-radius: 50%; background: #58a6ff; border: 2px solid #fff; }
  .best-ref-box { font-size: 10px; color: #d29922; font-weight: bold; background: rgba(210, 153, 34, 0.1); padding: 2px 6px; border-radius: 4px; border: 1px dashed #d29922; }
  .fixed-top { flex: none; z-index: 50; background: #0b1219; padding-bottom: 5px; }
  .scroll-v { overflow-y: auto; flex: 1; padding: 10px; }
  .hidden { display: none !important; }
</style>
</head>
<body class="p-2 space-y-2">

<div class="fixed-top space-y-2">
  <header class="text-center py-1 bg-[#161b22] rounded-lg border border-gray-800">
	<h1 class="text-gray-200 text-sm font-bold tracking-[0.3em] uppercase">PID 模拟器</h1>
  </header>

  <nav class="flex gap-2 p-1 bg-[#0d1117] rounded-xl border border-gray-800">
	<button onclick="switchMode('temp')" id="btn-temp" class="flex-1 py-2 rounded-lg text-xs font-bold transition-all tab-active">蒸汽减温系统</button>
	<button onclick="switchMode('level')" id="btn-level" class="flex-1 py-2 rounded-lg text-xs font-bold transition-all text-gray-500">液位控制系统</button>
  </nav>

  <section class="grid grid-cols-12 gap-2">
	<div class="col-span-4 card flex flex-col items-center justify-center border-t-2 border-blue-500">
	  <div id="best-display" class="absolute top-2 left-2 text-[8px] text-yellow-500/80 leading-tight">计算中...</div>
	  <div class="text-blue-400 text-2xl lcd mt-2" id="pv-lcd">450.0</div>
	  <div class="text-[9px] text-gray-500 mt-1 uppercase" id="pv-label">Temp PV (℃)</div>
	  <div class="w-full bg-black h-1 mt-3 rounded-full overflow-hidden">
		<div id="pv-bar" class="h-full bg-blue-500" style="width: 50%"></div>
	  </div>
	</div>
	<div class="col-span-8 card p-1"><canvas id="mainChart" style="max-height: 100px;"></canvas></div>
  </section>
</div>

<div class="scroll-v space-y-4">
  <section class="grid grid-cols-3 gap-2 text-center">
	<div class="card border-l-4 border-red-500 py-1"><div class="text-[8px] text-gray-400">设定 SP</div><div id="sp-lcd" class="text-red-500 text-lg lcd">450.0</div></div>
	<div class="card border-l-4 border-yellow-500 py-1"><div class="text-[8px] text-gray-400">实际阀位</div><div id="act-lcd" class="text-yellow-500 text-lg lcd">60.0%</div></div>
	<div class="card border-l-4 border-green-500 py-1"><div class="text-[8px] text-gray-400">输出 MV</div><div id="mv-lcd" class="text-green-500 text-lg lcd">60.0%</div></div>
  </section>

  <div class="space-y-3">
	<h2 class="text-[10px] text-gray-500 font-bold ml-1 uppercase">PID 参数控制</h2>
	<div class="card">
	  <div class="flex justify-between items-center mb-1">
		<span class="text-xs font-bold">PB (比例带)</span>
		<div class="flex gap-2 items-center">
		  <span class="best-ref-box" id="ref-pb">Ref: --</span>
		  <span class="bg-gray-900 text-blue-400 px-2 py-1 rounded lcd text-xs" id="pb-val">60</span>
		</div>
	  </div>
	  <input type="range" id="pb-in" min="10" max="200" value="60" oninput="update('pb', this.value)">
	</div>
	<div class="card">
	  <div class="flex justify-between items-center mb-1">
		<span class="text-xs font-bold">TI (积分秒)</span>
		<div class="flex gap-2 items-center"><span class="best-ref-box" id="ref-ti">Ref: --</span><span class="bg-gray-900 text-green-400 px-2 py-1 rounded lcd text-xs" id="ti-val">40s</span></div>
	  </div>
	  <input type="range" id="ti-in" min="5" max="200" value="40" oninput="update('ti', this.value)">
	</div>
	<div class="card">
	  <div class="flex justify-between items-center mb-1">
		<span class="text-xs font-bold">TD (微分秒)</span>
		<div class="flex gap-2 items-center"><span class="best-ref-box" id="ref-td">Ref: --</span><span class="bg-gray-900 text-purple-400 px-2 py-1 rounded lcd text-xs" id="td-val">10s</span></div>
	  </div>
	  <input type="range" id="td-in" min="0" max="20" value="10" oninput="update('td', this.value)">
	</div>
  </div>

  <div class="space-y-3">
	<h2 class="text-[10px] text-gray-500 font-bold ml-1 uppercase">过程特性控制</h2>
	<div id="temp-only" class="space-y-3">
		<div class="card border-l-2 border-purple-500"><div class="flex justify-between text-xs mb-1"><span>温度惯性</span><span id="inertia-val" class="text-white">0.5</span></div><input type="range" id="inertia-in" min="0.1" max="0.9" step="0.1" value="0.5" oninput="update('inertia', this.value)"></div>
		<div class="card border-l-2 border-red-500"><div class="flex justify-between text-xs mb-1"><span>升温速度</span><span id="heatRate-val" class="text-white">0.1</span></div><input type="range" id="heatRate-in" min="0.1" max="3.0" step="0.1" value="0.1" oninput="update('heatRate', this.value)"></div>
	</div>
	<div id="level-only" class="space-y-3 hidden">
		<div class="card border-l-2 border-cyan-500"><div class="flex justify-between text-xs mb-1"><span>液位上升速度</span><span id="levelUp-val" class="text-white">0.1</span></div><input type="range" id="levelUp-in" min="0.01" max="2.0" step="0.01" value="0.1" oninput="update('levelUp', this.value)"></div>
	</div>
	<div class="card">
	  <div class="flex justify-between text-xs mb-1 text-red-400"><span>设定目标 SP</span><span id="sp-val" class="text-white">450</span></div>
	  <input type="range" id="sp-in" min="350" max="600" value="450" oninput="update('sp', this.value)">
	</div>
  </div>

  <div class="py-6 space-y-3">
	<div class="flex gap-2">
		<button onclick="toggle()" id="runBtn" class="flex-1 bg-blue-600 py-4 rounded-xl font-bold text-white shadow-lg active:scale-95 transition-all">开始仿真</button>
		<button onclick="location.reload()" class="w-1/4 bg-gray-800 py-4 rounded-xl text-sm text-gray-400">重置</button>
	</div>
	<div class="text-center text-[10px] text-gray-600 tracking-widest pb-4">模拟器仅供参考学习 制作人: 刘飞</div>
  </div>
</div>

<script>
let mode = 'temp';
let s = {
  pv: 450, sp: 450, mv: 60, actMV: 60, integral: 0, lastPv: 450, processVal: 450, delayQueue: [],
  p: { pb: 60, ti: 40, td: 10, vspeed: 30, dt: 4.0, load: 60, heatRate:0.1, coolRate:0.2, inertia:0.5, levelUp:0.1, levelDown:0.1 },
  log: { pv: [], sp: [], act: [] }, isRunning: false
};
let chart; const dt = 0.1;

function initChart() {
  const ctx = document.getElementById('mainChart').getContext('2d');
  chart = new Chart(ctx, {
	type: 'line',
	data: { labels: Array(100).fill(''), datasets: [{ label: 'PV', data: [], borderColor: '#58a6ff', borderWidth: 2, pointRadius: 0 }, { label: 'SP', data: [], borderColor: '#f85149', borderWidth: 1, borderDash: [3,3], pointRadius: 0 }, { label: 'Valve', data: [], borderColor: '#fbbf2433', fill: true, borderWidth: 1, pointRadius: 0, yAxisID: 'y1' }]},
	options: { responsive: true, maintainAspectRatio: false, animation: false, scales: { y: { min: 350, max: 600, grid: { color: '#2a2e35' }, ticks: { font: {size: 8}, color: '#8b949e' } }, y1: { position: 'right', min: 0, max: 100, display: false }, x: { display: false } }, plugins: { legend: { display: false } } }
  });
}

function switchMode(m) {
  mode = m;
  const isTemp = m === 'temp';
  document.getElementById('temp-only').className = isTemp ? 'space-y-3' : 'hidden';
  document.getElementById('level-only').className = isTemp ? 'hidden' : 'space-y-3';
  document.getElementById('btn-temp').className = `flex-1 py-2 rounded-lg text-xs font-bold transition-all ${isTemp?'tab-active':'text-gray-500'}`;
  document.getElementById('btn-level').className = `flex-1 py-2 rounded-lg text-xs font-bold transition-all ${!isTemp?'tab-active':'text-gray-500'}`;
  
  // 关键修复点：切换模式时更新初始数值和量程
  if(isTemp) {
	s.pv = 450; s.sp = 450; s.processVal = 450;
	document.getElementById('pv-label').innerText = "Temp PV (℃)";
	document.getElementById('sp-in').min = 350; document.getElementById('sp-in').max = 600;
	chart.options.scales.y.min = 350; chart.options.scales.y.max = 600;
  } else {
	s.pv = 50; s.sp = 50; s.processVal = 50;
	document.getElementById('pv-label').innerText = "Level PV (%)";
	document.getElementById('sp-in').min = 0; document.getElementById('sp-in').max = 100;
	chart.options.scales.y.min = 0; chart.options.scales.y.max = 100;
  }
  
  s.integral = 0; s.log.pv = []; s.log.sp = []; s.log.act = [];
  update('sp', s.sp); autoCalcPID(); chart.update('none');
}

// 其余逻辑（calculate, updateUI, toggle）保持不变
function autoCalcPID() {
  const L = s.p.dt + (s.p.vspeed * 0.15); const T = mode === 'temp' ? 40 : 80;
  let bPB = mode === 'temp' ? Math.round(70 * (L/T + 0.5)) : Math.round(40 * (L/T + 1.2));
  let bTI = mode === 'temp' ? Math.round(2 * L + T * 0.1) : Math.round(3 * L + 10);
  let bTD = mode === 'temp' ? Math.round(0.4 * L) : Math.round(0.2 * L);
  document.getElementById('ref-pb').innerText = `Ref: ${bPB}`; document.getElementById('ref-ti').innerText = `Ref: ${bTI}s`; document.getElementById('ref-td').innerText = `Ref: ${bTD}s`;
  document.getElementById('best-display').innerHTML = `屏幕提示:<br>PB:${bPB} TI:${bTI} TD:${bTD}`;
}

function update(id, val) {
  let v=parseFloat(val); if(id === 'sp') s.sp=v; else if(s.p.hasOwnProperty(id)) s.p[id] = v;
  let unit = (['dt','vspeed','ti','td'].includes(id)) ? 's' : '';
  let display = document.getElementById(id + '-val'); if(display) display.innerText=v + unit;
  if(id === 'sp') document.getElementById('sp-lcd').innerText=v.toFixed(1);
  autoCalcPID();
}

function calculate() {
  const p=s.p; let Kp=100/p.pb; let err=mode === 'temp' ? (s.pv-s.sp) : (s.sp-s.pv);
  if (!((s.mv >= 100 && err > 0) || (s.mv <= 0 && err < 0))) s.integral += (Kp/p.ti)*err*dt;
  let dTerm=Kp*p.td*(s.pv-s.lastPv)/dt;
  s.mv=Math.max(0, Math.min(100, (Kp*err+s.integral+(mode==='temp'?dTerm:-dTerm))+p.load));
  let maxStep=(100/p.vspeed)*dt; let diff=s.mv-s.actMV; s.actMV += Math.abs(diff) > maxStep ? Math.sign(diff)*maxStep : diff;
  s.delayQueue.push(s.actMV); let dSteps=Math.max(1, Math.floor(p.dt/dt));
  while(s.delayQueue.length > dSteps) s.effMV=s.delayQueue.shift(); s.lastPv=s.pv;
  if(mode === 'temp') {
	let valDiff=p.load-(s.effMV||s.actMV); let targetVal=s.processVal+valDiff*(valDiff>0?p.heatRate:p.coolRate)*dt;
	s.processVal=p.inertia*s.processVal+(1-p.inertia)*Math.max(350, Math.min(600, targetVal));
  } else {
	let valDiff=(s.effMV||s.actMV)-p.load; s.processVal += valDiff*(valDiff>0?p.levelUp/100:p.levelDown/100);
	s.processVal=Math.max(0, Math.min(100, s.processVal));
  }
  s.pv=s.processVal+(Math.random()-0.5)*0.1; updateUI();
}

function updateUI() {
  document.getElementById('pv-lcd').innerText=s.pv.toFixed(1);
  document.getElementById('act-lcd').innerText=s.actMV.toFixed(1) + '%';
  document.getElementById('mv-lcd').innerText=s.mv.toFixed(1) + '%';
  let barH=mode === 'temp' ? (s.pv-350)/(600-350)*100 : s.pv;
  document.getElementById('pv-bar').style.width=Math.min(100, Math.max(0, barH)) + '%';
  s.log.pv.push(s.pv); s.log.sp.push(s.sp); s.log.act.push(s.actMV);
  if(s.log.pv.length > 100) { s.log.pv.shift(); s.log.sp.shift(); s.log.act.shift(); }
  chart.data.datasets[0].data=s.log.pv; chart.data.datasets[1].data=s.log.sp; chart.data.datasets[2].data=s.log.act; chart.update('none');
}

function toggle() {
  s.isRunning = !s.isRunning; const btn=document.getElementById('runBtn');
  btn.innerText=s.isRunning ? "暂停运行" : "开始仿真"; btn.style.background=s.isRunning ? "#991b1b" : "#2563eb";
  if(s.isRunning) timer=setInterval(calculate, 100); else clearInterval(timer);
}
window.onload = () => { initChart(); switchMode('temp'); };
</script>
</body>
</html>